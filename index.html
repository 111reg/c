<!DOCTYPE html>
<html>
  <head>
    <title>Google Drive API 測試</title>
    <meta charset="utf-8" />
    <style>
      body { font-family: sans-serif; padding: 20px; }
      button { padding: 10px 20px; font-size: 16px; margin-right: 10px; cursor: pointer;}
      #content { margin-top: 20px; white-space: pre-wrap; background: #f4f4f4; padding: 10px; border-radius: 5px;}
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <h1>Google Drive 檔案讀取器</h1>

    <button id="authorize_button" onclick="handleAuthClick()">登入並授權</button>
    <button id="signout_button" onclick="handleSignoutClick()">登出</button>

    <div id="content">等待操作...</div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
      /* * TODO(重要): 請將下方的 CLIENT_ID 和 API_KEY 換成你自己的！
       */
      const CLIENT_ID = '747489154792-97q5ftdt2ii6bpbiva3hbtdvk8puq1f4.apps.googleusercontent.com'; // 貼上你的 OAuth 用戶端 ID
      const API_KEY = 'AIzaSyCalEqkmPm46fpDkOWINqQTuVzgSne7PGs';     // 貼上你的 API 金鑰

      // 權限範圍：這裡使用 metadata.readonly (唯讀) 作為測試
      // 如果你要上傳檔案，請改成 'https://www.googleapis.com/auth/drive.file'
      const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

      // Google Drive API 的探索文件
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';

      // 1. 載入 gapi (Google API Client)
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      // 2. 初始化 gapi
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      // 3. 載入 GIS (Google Identity Services)
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // 定義在登入按鈕點擊時
        });
        gisInited = true;
        maybeEnableButtons();
      }

      // 4. 啟用按鈕
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      // 5. 處理登入點擊
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error) {
            throw (resp);
          }
          await listFiles();
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('authorize_button').innerText = '重新整理';
        };

        if (gapi.client.getToken() === null) {
          // 如果沒有 Token，觸發登入視窗
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // 如果已有 Token，略過登入，直接重新整理
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      // 6. 處理登出
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content').innerText = '已登出。';
          document.getElementById('authorize_button').innerText = '登入並授權';
          document.getElementById('signout_button').style.visibility = 'hidden';
        }
      }

      // 7. 呼叫 Drive API 列出檔案
      async function listFiles() {
        try {
          const response = await gapi.client.drive.files.list({
            'pageSize': 10,
            'fields': 'files(id, name)',
          });
          const files = response.result.files;
          if (!files || files.length == 0) {
            document.getElementById('content').innerText = '找不到檔案。';
            return;
          }
          
          let output = '你的雲端硬碟檔案 (前 10 個):\n\n';
          files.forEach((file) => {
            output += `${file.name} (${file.id})\n`;
          });
          document.getElementById('content').innerText = output;
        } catch (err) {
          document.getElementById('content').innerText = err.message;
        }
      }
    </script>
  </body>
</html>